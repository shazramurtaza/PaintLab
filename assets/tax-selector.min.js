function checkNullUndefined(e) {
    return null != e;
}

function vatCreateCookie(e, t, n) {
    if (n) {
        var a = new Date();
        a.setTime(a.getTime() + 24 * n * 60 * 60 * 1e3);
        var c = "; expires=" + a.toGMTString();
    } else c = "";
    document.cookie = e + "=" + t + c + "; path=/";
}

function vatReadCookie(e) {
    for (
        var t = e + "=", n = document.cookie.split(";"), a = 0;
        a < n.length;
        a++
    ) {
        for (var c = n[a]; " " == c.charAt(0); ) c = c.substring(1, c.length);
        if (0 == c.indexOf(t)) return c.substring(t.length, c.length);
    }
    return null;
}

function vatEraseCookie(e) {
    vatCreateCookie(e, "", -1);
}

function readAppStatus() {
    return window.vatSwitcher.status;
}

function readPricingStatus() {
    return window.vatSwitcher.includingTax;
}

function readCountry() {
    if (window.vatSwitcher.displayCountrySelector) {
        var e = vatReadCookie("vatCountry");
        if (checkNullUndefined(e)) {
            return e;
        } else {
            vatCreateCookie(
                "vatCountry",
                window.vatSwitcher.defaultCountry,
                window.vatSwitcher.cookie_validity
            );
            return window.vatSwitcher.defaultCountry;
        }
    } else {
        return Shopify.country;
    }
}

function readTaxAmount() {
    var e = readCountry(),
        t = window.vatSwitcher.taxConfig[e],
        n = window.vatSwitcher.currentCollection,
        a = window.vatSwitcher.currentProduct;
    if (!checkNullUndefined(t)) {
        console.log("Tax config for selected country not defined.");
        return false;
    }
    if (t.single_tax) {
        return t.tax_amount;
    }
    if (checkNullUndefined(n)) {
        if (checkNullUndefined(t.collections[n.id])) {
            return t.collections[n.id];
        } else {
            console.log(
                "Tax config for selected country for current collection is not defined."
            );
            return false;
        }
    }
    if (checkNullUndefined(a)) {
        return (
            a.forEach(function (e, n) {
                if (checkNullUndefined(t.collections[e]))
                    return t.collections[e];
            }),
            console.log(
                "Tax config for selected country for current product is not defined."
            ),
            !1
        );
    }
}

function readTranslations() {
    var e = document.documentElement.lang;
    if (checkNullUndefined(e) && checkNullUndefined(window.vatSwitcher.translations[e])) {
        return window.vatSwitcher.translations[e];
    } else {
       return window.vatSwitcher.translations[Object.keys(window.vatSwitcher.translations)['0']];
    }
}

function changeAllHelper(e) {
    document.querySelectorAll(".tax-price-helper").forEach(function (t) {
        t.innerHTML = " (" + e + ")";
    });
}

function changeAllText(e, t) {
    document.querySelectorAll(e).forEach(function (e) {
        e.innerHTML = t;
    });
}

function changeLanguage(e) {
    changeAllText(".vat-switcher-info h2", e.popupTitle);
    changeAllText(".vat-switcher-info p", e.popupSubtitle);
    changeAllText(
        ".vat-switcher-account.company button.account-type",
        e.b2bButton
    );
    changeAllText(".vat-switcher-account.company p.description", e.b2bHelper);
    changeAllText(
        ".vat-switcher-account.private button.account-type",
        e.b2cButton
    );
    changeAllText(".vat-switcher-account.private p.description", e.b2cHelper);
    if (document.querySelector(".vat-switcher-inline") !== null) {
        changeAllText(
            '.vat-switcher-inline [data-vat-type="b2b"] h2',
            e.b2bButton
        );
        changeAllText(
            '.vat-switcher-inline [data-vat-type="b2b"] p',
            e.b2bHelper
        );
        changeAllText(
            '.vat-switcher-inline [data-vat-type="b2c"] h2',
            e.b2cButton
        );
        changeAllText(
            '.vat-switcher-inline [data-vat-type="b2c"] p',
            e.b2cHelper
        );
    }
    if (document.querySelector(".vat-switcher-floating") !== null) {
        document
            .querySelector(
                ".vat-switcher-floating .floating-button.color-switcher"
            )
            .setAttribute("tooltip", e.popupSubtitle);
        document
            .querySelector(
                ".vat-switcher-floating .floating-button.color-country"
            )
            .setAttribute("tooltip", e.changeCountry);
        document
            .querySelector('.vat-switcher-floating [data-vat-type="b2c"]')
            .setAttribute("tooltip", e.b2cButton + " (" + e.b2cHelper + ")");
        document
            .querySelector('.vat-switcher-floating [data-vat-type="b2b"]')
            .setAttribute("tooltip", e.b2bButton + " (" + e.b2bHelper + ")");
    }
}

function getPrice(e, t, n) {
    var checkComma = t.indexOf(",");
    var checkDot = t.indexOf(".");
    var a = t.replace(/[^0-9]/g, "");
    var c = t
    .replace(/[0-9]/, "__")
    .replace(/\d+([,.]\d+)?/g, "")
    .replace(/,/g, "")
    .replace(/\./g, "");
    if (e == "b2b") {
        var b = ((100 * parseInt(a)) / (100 + parseFloat(n))).toFixed(0);
    } else {
        var b = (parseInt(a) + parseInt(a * n) / 100).toFixed(0);
    }
    if (checkComma > 0 && checkDot > 0) {
        if (checkComma > checkDot) {
            var f = new Intl.NumberFormat("de-DE").format(b / 100);
        } else {
            var f = new Intl.NumberFormat("en-US").format(b / 100);
        }
    } else if (checkComma > 0 && checkDot < 0) {
        var g = t.replace(/[^0-9\.\,]/g, "");
        if (g.length - (g.indexOf(",") + 1) == 2) {
            // COMMA SEPERATOR FOR DECIMAL VAL
            var f = new Intl.NumberFormat("de-DE").format(b / 100);
        } else {
            var f = new Intl.NumberFormat("en-US").format(b);
            // No decimal Seperator
        }
    } else if (checkComma < 0 && checkDot > 0) {
        var g = t.replace(/[^0-9\.\,]/g, "");
        if (g.length - (g.indexOf(".") + 1) == 2) {
            var f = new Intl.NumberFormat("en-US").format(b / 100);
            // DOT SEPERATOR FOR DECIMAL VAL
        } else {
            var f = new Intl.NumberFormat("ed-DE").format(b);
            // No decimal Seperator
        }
    } else {
        var f = b;
        // Divide by 100
    }
    return c.replace("__", f);
}

function initPrices(e, n) {
    document
        .querySelectorAll(window.vatSwitcher.priceSelector)
        .forEach(function (t) {
            let priceHelper = t.nextElementSibling;
            if (priceHelper !== null) {
                if (!priceHelper.classList.contains("tax-price-helper")) {
                    var el = document.createElement("span");
                    el.classList.add("tax-price-helper");
                    t.parentNode.insertBefore(el, t.nextSibling);
                }
            } else {
                var el = document.createElement("span");
                el.classList.add("tax-price-helper");
                t.parentNode.insertBefore(el, t.nextSibling);
            }
            if (!t.hasAttribute('data-b2b') || !t.hasAttribute('data-b2c')) {
                if (n === "b2c") {
                    t.setAttribute("data-b2b", getPrice("b2b", t.innerHTML, e)),
                        t.setAttribute("data-b2c", t.innerHTML);
                } else {
                    t.setAttribute("data-b2c", getPrice("b2c", t.innerHTML, e)),
                        t.setAttribute("data-b2b", t.innerHTML);
                }
            }
        });
}

function changePrices(e) {
    document
        .querySelectorAll(window.vatSwitcher.priceSelector)
        .forEach(function (t) {
            t.getAttribute("data-pricing");
            t.setAttribute("data-pricing", e);
            var n = t.getAttribute("data-" + e);
            t.innerHTML = n;
        });
}

function vatSwitcherChangeAll(e) {
    if (checkNullUndefined(e)) {
        if (document.querySelector(".vat-switcher-inline") !== null) {
            document
                .querySelectorAll(".vat-switcher-inline > a")
                .forEach(function (e) {
                    e.classList.remove("active");
                }),
                document
                    .querySelectorAll(
                        '.vat-switcher-inline > a[data-vat-type="' + e + '"]'
                    )
                    .forEach(function (e) {
                        e.classList.add("active");
                    });
        }
    }
    var t = readTaxAmount();
    if (t) {
        if (void 0 === e) {
            if (readPricingStatus()) {
                var n = "b2c";
            } else {
                var n = "b2b";
            }
            initPrices(t, n);
        } else {
            changePrices((n = e));
        }
        var a = readTranslations();
        changeAllHelper("b2b" === n ? a.b2bHelper : a.b2cHelper);
    } else {
        console.log(
            "VAT Rules for current product / collection not defined for selected country"
        );
    }
}

function vatSwitcherInit() {
    vatSwitcherChangeAll();
    changeLanguage(readTranslations());
    var e = vatReadCookie("vatCountry");
    if (e == null) {
        vatEraseCookie("vatCountry");
        vatCreateCookie("vatCountry", window.vatSwitcher.defaultCountry, window.vatSwitcher.cookie_validity);
    }
    var t = vatReadCookie("pricingFormat");
    if (t == null) {
        if (window.vatSwitcher.displayPopup) {
            document.querySelector(".vat-switcher-popup").style.display =
                "block";
        } else {
            vatEraseCookie("pricingFormat");
            vatCreateCookie(
                "pricingFormat",
                window.vatSwitcher.defaultPricing,
                window.vatSwitcher.cookie_validity
            );
            vatSwitcherChangeAll(window.vatSwitcher.defaultPricing);
        }
    } else {
        document.querySelector(".vat-switcher-popup").style.display = "none";
        vatSwitcherChangeAll(t);
    }
}

if (document.querySelector(".vat-switcher-inline") !== null) {
    document.querySelectorAll(".vat-switcher-inline").forEach(function (e) {
        e.innerHTML =
            '<a href="javascript:;" class="account-type" data-vat-type="b2b"><h2>Business</h2><p>Excl. VAT</p></a><a href="javascript:;" class="account-type" data-vat-type="b2c"><h2>Individual</h2><p>Incl. VAT</p></a>';
    });
}

document.querySelectorAll(".account-type").forEach(function (e) {
    e.addEventListener("click", function (t) {
        vatEraseCookie("pricingFormat");
        vatCreateCookie("pricingFormat", e.dataset.vatType, window.vatSwitcher.cookie_validity);
        document.querySelector(".vat-switcher-popup").style.display = "none";
        vatSwitcherChangeAll(e.dataset.vatType);
        if (document.querySelector(".vat-switcher-inline") !== null) {
            document
                .querySelectorAll(
                    '.vat-switcher-inline a[data-vat-type="' +
                        e.dataset.vatType +
                        '"]'
                )
                .forEach(function (e) {
                    e.classList.add("active");
                });
            document
                .querySelectorAll(
                    '.vat-switcher-inline a[data-vat-type]:not([data-vat-type="' +
                        e.dataset.vatType +
                        '"])'
                )
                .forEach(function (e) {
                    e.classList.remove("active");
                });
        }
    });
});

document
    .querySelector(".vat-switcher-popup .close-btn")
    .addEventListener("click", function (e) {
        var t = vatReadCookie("pricingFormat");
        if (null == t || t == undefined ) {
            vatEraseCookie("pricingFormat");
            vatCreateCookie(
                "pricingFormat",
                window.vatSwitcher.defaultPricing,
                window.vatSwitcher.cookie_validity
            );
            vatSwitcherChangeAll(window.vatSwitcher.defaultPricing);
            document.querySelector(".vat-switcher-popup").style.display =
                "none";
        } else {
          vatSwitcherChangeAll(t);
          document.querySelector(".vat-switcher-popup").style.display =
                "none";
        }
    });

if (Object.entries(window.vatSwitcher.taxConfig).length > 1) {
    var dataCountrySelector = "";
    for (const [e, t] of Object.entries(window.vatSwitcher.taxConfig)) {
        if (e == vatReadCookie("vatCountry")) {
            var selected = "selected";
        } else {
            selected = "";
        }
        dataCountrySelector += `<option value="${e}" ${selected}>${t.country_name}</option>`;
    }
    document.querySelector(".country-selector-select").innerHTML =
        dataCountrySelector;
} else {
    document.querySelector(".color-country").style.display = "none";
    document.querySelector(".country-selector").style.display = "none";
}

document
    .querySelector(".country-selector-select")
    .addEventListener("change", function (e) {
        vatEraseCookie("vatCountry");
        vatCreateCookie("vatCountry", e.target.value, window.vatSwitcher.cookie_validity);
        location.reload();
    });

document
    .querySelector(".color-country")
    .addEventListener("click", function (e) {
        document.querySelector(".vat-switcher-popup").style.display = "block";
    });

document.addEventListener("DOMContentLoaded", function (e) {
    if (readAppStatus()) {
        if (Object.keys(window.vatSwitcher.translations).length){
            vatSwitcherInit();
        } else {
            document.querySelector(".vat-switcher-popup").style.display = "none";
            document.querySelector(".vat-switcher-floating").style.display = "none";
            console.log("Translation strings not defined");
        }
    } else {
        document.querySelector(".vat-switcher-popup").style.display = "none";
        document.querySelector(".vat-switcher-floating").style.display = "none";
        console.log("VAT Switcher is disabled");
    }
});

document.addEventListener("shopify:section:select", function (event) {
    if (event.detail.sectionId !== "tax-selector") return;
    document.querySelector(".vat-switcher-popup").style.display = "block";
});

document.addEventListener("shopify:section:deselect", function (event) {
    if (event.detail.sectionId !== "tax-selector") return;
    document.querySelector(".vat-switcher-popup").style.display = "none";
});

var observer = new MutationObserver(function (mutationsList, observer) {
    mutationsList.forEach(function (m) {
        var oldData = m.removedNodes["0"].textContent,
            newData = m.addedNodes["0"].textContent,
            b2cPrice = m.target.dataset.b2c,
            b2bPrice = m.target.dataset.b2b,
            pricingFormat = m.target.dataset.pricing,
            formattedOldData = oldData.replace(/[^0-9a-zA-Z.]/g, ""),
            formattedNewData = newData.replace(/[^0-9a-zA-Z.]/g, ""),
            formattedB2cPricing = b2cPrice.replace(/[^0-9a-zA-Z.]/g, ""),
            formattedB2bPricing = b2bPrice.replace(/[^0-9a-zA-Z.]/g, "");
        if (
            pricingFormat === undefined ||
            formattedB2bPricing === undefined ||
            formattedB2cPricing === undefined ||
            formattedNewData === undefined
        ) {
            vatSwitcherInit();
        } else {
            if (
                pricingFormat === "b2b" &&
                formattedB2bPricing !== formattedNewData
            ) {
                vatSwitcherInit();
            } else if (
                pricingFormat === "b2c" &&
                formattedB2cPricing !== formattedNewData
            ) {
                vatSwitcherInit();
            }
        }
    });
});

if (document.querySelectorAll(window.vatSwitcher.priceSelector).length) {
    if (window.vatSwitcher.currentProduct !== undefined) {
        document
            .querySelectorAll(window.vatSwitcher.priceSelector)
            .forEach(function (t) {
                observer.observe(t, {
                    characterData: false,
                    childList: true,
                    attributes: false,
                });
            });
    }
}