
/****PLEASE DON'T MAKE CHANGES IN THIS FILE IT'S AFFECT THE CODE IF YOU NEED ANY HELP PLEASE CONTACT TO FLITS TEAM support@getflits.com ****/
(function(Flits,StoreCreditCart){StoreCreditCart=Flits.StoreCreditCart=function(options){function generate_dropdown_code(data){var moneyFormat=Flits.money_format;var total_credits=data.total_credits;if(total_credits<=0)return'';var rules=data.rules;if(rules.length<=0)return'';var $selectConatiner=Flits("<div class='flits-select-row flits-cart-drp'/>");var $result=Flits("<select class='"+Flits.StoreCreditCart.settings.creditDropdownClass+"' />");$selectConatiner.append('<div class="flits-select-arrow">'+'<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" shape-rendering="geometricPrecision"><path d="M6 9l6 6 6-6"></path></svg>'+'</div>'),rules.length>0&&$result.append("<option value='-1'>"+Flits.t('Flits.locals.cart_page.select_credit_option','Select option to use store credit')+'</option>');for(var i=0;i<rules.length;i++){var credits=rules[i].applicable_credits;var rule_id=rules[i].rule.id;var option_text='You can use {{ credit }} credit out of {{ total_credit }}.';switch(rules[i].rule.rule.column.name){case'cart_value':option_text=Flits.t('Flits.locals.cart_page.credit_cart_percentage','You can use {{ credit }} credit out of {{ total_credit }}.').replace('{{ credit }}',Flits.formatMoney(Math.abs(credits),moneyFormat));option_text=option_text.replace('{{ total_credit }}',Flits.formatMoney(Math.abs(total_credits),moneyFormat));break;default:option_text=option_text.replace('{{ credit }}',Flits.formatMoney(Math.abs(credits),moneyFormat));option_text=option_text.replace('{{ total_credit }}',Flits.formatMoney(Math.abs(total_credits),moneyFormat));break;}$result.append("<option value='"+rule_id+"'>"+option_text+'</option>');}return $selectConatiner.append($result),Flits($selectConatiner);}function get_spent_rules(cart){if(cart.total_price<=0)return;cart=setupCartData(cart);var lastLoadedCart=Flits.getLocalStorage('lastLoadedCart');if(Flits.compareObject(lastLoadedCart,cart)){var res=Flits.getLocalStorage('lastLoadedSpentRules');return setupSpentRules(res,!0),!0;}Flits.setLocalStorage('lastLoadedCart',cart);var url=[Flits.base_url,Flits.customer_id].join('/')+Flits.StoreCreditCart.settings.get_spent_rules_route;Flits.ajax({url:url,method:'POST',data:{customer_hash:Flits.customerHash,token:Flits.token,cart:btoa(unescape(encodeURIComponent(JSON.stringify(cart))))}}).done(function(res){setupSpentRules(res,!1);});}function setupSpentRules(res,isOldCartData){if(Flits.setLocalStorage('lastLoadedSpentRules',res),res.is_credit_on_cart=='0')return;if(isOldCartData)return;var code=generate_dropdown_code(res.code);Flits('.'+Flits.StoreCreditCart.settings.main_div_class).appendStoreCreditDropDown(code);}function apply_credit(cart){if(cart.total_price<=0)return Flits.redirectToCheckout({discount:'+'}),!1;var checkoutProcessData=Flits.StoreCreditCart.settings.checkoutProcessData;if(Flits.isEmptyObject(checkoutProcessData)||checkoutProcessData.spentRuleId==-1||!checkoutProcessData.spentRuleId)return Flits.redirectToCheckout({discount:'+'}),!1;cart=setupCartData(cart);var url=[Flits.base_url,Flits.customer_id].join('/')+Flits.StoreCreditCart.settings.apply_credit_route;Flits.ajax({url:url,method:'post',data:{customer_hash:Flits.customerHash,token:Flits.token,data:btoa(unescape(encodeURIComponent(JSON.stringify(cart)))),spent_rule_id:checkoutProcessData.spentRuleId}}).done(function(res){if(!res.status){Flits.redirectToCheckout({discount:'+'});return;}Flits.redirectToCheckout({discount:res.code});return;}).fail(function(){Flits.redirectToCheckout({discount:'+'});});}function removeOldDiscountCodes(){var url=[Flits.base_url,Flits.customer_id].join('/')+Flits.StoreCreditCart.settings.delete_discounts_route;return Flits.ajax({url:url,method:'post',data:{customer_hash:Flits.customerHash,token:Flits.token}});}function setupCartData(cart){Object.defineProperty(cart,'cart_token',Object.getOwnPropertyDescriptor(cart,'token')),delete cart.token;var remove_attribute=Flits.StoreCreditCart.settings.removeAttributesFromCart;for(var i=0;i<cart.items.length;i++)for(var j=0;j<remove_attribute.length;j++)Flits.isNull(cart.items[i][remove_attribute[j]])||delete cart.items[i][remove_attribute[j]];return cart;}function checkoutProcess(event,btn){if(checkIntegratedApplicationCode(),!Flits.StoreCreditCart.settings.isProcessCheckout)return!1;var parent=btn.closest('[data-flits="'+Flits.StoreCreditCart.settings.checkoutButtonParentParameterValue+'"]');if(!parent)return!0;var element=Flits(parent).find('.flits-want-to-use-credit');var spentRuleId=-1;if(element.length<=0)return!0;var isStoreCreditApply=!1;switch(element.prop('tagName').toString().toLowerCase()){case'checkbox':isStoreCreditApply=element.is(':checked');spentRuleId=element.val();break;case'select':spentRuleId=element.val();spentRuleId!='-1'&&(isStoreCreditApply=!0);break;default:break;}if(!isStoreCreditApply||spentRuleId==-1)return!0;event.preventDefault(),event.stopPropagation(),event.stopImmediatePropagation();var old_text=Flits(btn).html();var new_text=Flits.t('Flits.locals.cart_page.applying_credit_message','Applying credit please wait');switch(Flits(btn).prop('tagName').toString().toLowerCase()){case'input':old_text=Flits(btn).val();Flits(btn).val(new_text);break;case'button':default:old_text=Flits(btn).html();Flits(btn).html(new_text);break;}return Flits(btn).attr('disabled',!0),Flits.StoreCreditCart.settings.checkoutProcessData={btn:btn,btnOldTxt:old_text,event:event,spentRuleId:spentRuleId},Flits.getCart().done(apply_credit).fail(function(){return Flits.redirectToCheckout({discount:'+'}),!1;}),!1;}function setupcheckoutProcess(event,submitBtn){event.preventDefault(),event.stopPropagation(),event.stopImmediatePropagation();var checkoutProcessResult=checkoutProcess(event,submitBtn);return checkoutProcessResult&&(Flits.StoreCreditCart.settings.isDeleteDiscount&&removeOldDiscountCodes(),Flits.redirectToCheckout({discount:'+'})),!1;}function add_events(){if(Flits(document).on('click','[data-flits="'+Flits.StoreCreditCart.settings.checkoutButtonParameterValue+'"]',function(event){var submitBtn=this;return setupcheckoutProcess.apply(Flits.StoreCreditCart,[event,submitBtn]);}),Flits(document).on('click',Flits.StoreCreditCart.settings.updateCartButtonSelectors.join(','),function(event){Flits(this).attr('data-flits','update-cart-btn');}),Flits(document).on('click',function(event){var ele=event.target;var isUpdateButton=!1;Flits.each(Flits(Flits.StoreCreditCart.settings.updateCartButtonSelectors.join(',')),function(index,item){return Flits(ele).is(Flits(this))?(isUpdateButton=!0,!1):void 0;}),isUpdateButton||Flits("[data-flits='update-cart-btn']").removeAttr('data-flits');}),Flits(document).on('submit',Flits.StoreCreditCart.settings.checkoutFormSelectors.join(','),function(event,extraParameter){if(!Flits.isNull(extraParameter)&&extraParameter.flitsFormSubmitted)return!0;if(Flits(this).find("[data-flits='update-cart-btn']").length>0)return!0;var submitBtn=null;return event.originalEvent&&event.originalEvent.submitter&&(submitBtn=event.originalEvent.submitter),!submitBtn&&document.activeElement.type=='submit'&&(submitBtn=document.activeElement),submitBtn||(submitBtn=Flits(this).find("[type='submit'][data-flits='"+Flits.StoreCreditCart.settings.checkoutButtonParameterValue+"']")),submitBtn?setupcheckoutProcess.apply(Flits.StoreCreditCart,[event,submitBtn]):!0;}),Flits.StoreCreditCart.settings.isAjaxCart){Flits.addToCartAjaxEvent(),Flits.updateCartAjaxEvent(),Flits.clearCartAjaxEvent(),Flits.getCartAjaxEvent();var debouncedFunction=Flits.debounce(function(event){Flits.checkAndSetupStoreCreditDiv(),Flits.getCart().done(get_spent_rules);},2500);Flits(document).on('Flits:AjaxCart:ProductAdded',debouncedFunction),Flits(document).on('Flits:AjaxCart:CartUpdated',debouncedFunction),Flits(document).on('Flits:AjaxCart:CartRendered',debouncedFunction),Flits.dispatchEvent('Flits:AjaxCart:Setup',{debouncedFunction:debouncedFunction});}}function checkIntegratedApplicationCode(){if(Flits.StoreCreditCart.settings.isProcessCheckout=!0,window.globoStores){var isDateTimeSelected=!0;if(window.globoStores.settings.storePickup.dateTimePicker.datePicker&&''==Flits(window.globoStores.datePicker.$node).val()&&(isDateTimeSelected=!1),window.globoStores.settings.storePickup.dateTimePicker.timePicker&&''==Flits(window.globoStores.timePicker.$node).val()&&(isDateTimeSelected=!1),!isDateTimeSelected){Flits('#pickupDateTimeErrorMsg').show(),Flits.StoreCreditCart.settings.isProcessCheckout=!1;return;}}if(window.Zapiet){var isDateTimeSelected=!1;if(window.Zapiet.Widget.checkoutEnabled()&&(isDateTimeSelected=!0),!isDateTimeSelected){Flits.StoreCreditCart.settings.isProcessCheckout=!1;return;}}Flits.dispatchEvent('Flits:IsCheckoutPossible');}function init(){Flits.checkAndSetupStoreCreditDiv(),Flits.setLocalStorage('lastLoadedCart',{}),Flits.setLocalStorage('lastLoadedSpentRules',{}),Flits.getCart().done(get_spent_rules),add_events();}Flits.StoreCreditCart.settings={};var settings={get_spent_rules_route:'/get_credit',apply_credit_route:'/credit/apply_credit',delete_discounts_route:'/delete-discounts',main_div_class:'flits-credit-code-div',creditDropdownClass:'flits-want-to-use-credit flits-input',checkoutButtonSelectors:["input[name='checkout']","button[name='checkout']","[href$='checkout']"],checkoutFormSelectors:["form[action$='/cart'][method='post']"],updateCartButtonSelectors:["form[action$='/cart'] input[name='update']","form[action$='/cart'] button[name='update']"],isCodeAutomatic:!0,automaticCodeDiv:'#flits-cart-automatic-code',checkoutButtonParameterValue:'store-credit-added',checkoutButtonParentParameterValue:'store-credit-parent',automaticAppendDivFunction:function(){},isAjaxCart:!0,isApplyCreditChecked:!1,isProcessCheckout:!0,isDeleteDiscount:!0,removeAttributesFromCart:['sku','featured_image','product_description','title','url','handle','product_type','product_title','discounts','variant_options','options_with_values','variant_title']};settings=Flits.extend(Flits.StoreCreditCart.settings,settings,options),Flits.dispatchEvent('Flits:StoreCreditCart:Loaded',{settings:settings}),init();},Flits.extend({checkAndSetupStoreCreditDiv:function(){Flits.StoreCreditCart.settings.isCodeAutomatic?Flits(Flits.StoreCreditCart.settings.checkoutButtonSelectors.join(',')).appendStoreCreditDiv():(Flits('.'+Flits.StoreCreditCart.settings.main_div_class).not('.flits-template').parents(Flits.StoreCreditCart.settings.automaticCodeDiv).show(),Flits('.'+Flits.StoreCreditCart.settings.main_div_class).not('.flits-template').attr('data-flits-manual-code',!0),Flits('.'+Flits.StoreCreditCart.settings.main_div_class).not('.flits-template').parents(Flits.StoreCreditCart.settings.automaticCodeDiv).parent().find(Flits.StoreCreditCart.settings.checkoutButtonSelectors.join(',')).attr('data-flits',Flits.StoreCreditCart.settings.checkoutButtonParameterValue),Flits('.'+Flits.StoreCreditCart.settings.main_div_class).not('.flits-template').parents(Flits.StoreCreditCart.settings.automaticCodeDiv).parent().attr('data-flits',Flits.StoreCreditCart.settings.checkoutButtonParentParameterValue));}}),Flits.fn.extend({appendStoreCreditDropDown:function(code){return this.each(function(index,item){Flits(item).html(''),Flits(item).append(Flits(code).clone(!0));}),this;},appendStoreCreditDiv:function(){var settings=Flits.StoreCreditCart.settings;return this.filter(':not([data-flits="'+Flits.StoreCreditCart.settings.checkoutButtonParameterValue+'"])').each(function(index,el){if(el=Flits(el),el.css('display')!='none'&&el.css('visibility')!='hidden'){if(typeof el[0].addEventListener!='function')return;var cloneNode=Flits(Flits.StoreCreditCart.settings.automaticCodeDiv).find('.'+Flits.StoreCreditCart.settings.main_div_class).clone(!0);Flits(cloneNode).removeClass('flits-template');var parent=el.parent();el.before(cloneNode),el.attr('data-flits',Flits.StoreCreditCart.settings.checkoutButtonParameterValue),parent.attr('data-flits',Flits.StoreCreditCart.settings.checkoutButtonParentParameterValue),Flits.StoreCreditCart.settings.automaticAppendDivFunction.apply(this,[el,parent,cloneNode]),Flits.dispatchEvent('Flits:CartAutomaticCode:Loaded',{el:el,parent:parent,cloneNode:cloneNode});}}),this;}}),StoreCreditCart(window.flitsObjects.StoreCreditCartPage);}(Flits));
